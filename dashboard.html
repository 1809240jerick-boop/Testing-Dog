<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barangay Registry Admin</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        :root {
            --primary: #667eea; 
            --primary-dark: #5a67d8;
            --accent: #764ba2;
            --text-dark: #2d3748;
            --text-light: #718096;
            --sidebar-bg: rgba(26, 32, 44, 0.95);
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: 1px solid rgba(255, 255, 255, 0.6);
            --success: #48bb78; 
            --danger: #f56565;
        }

        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(rgba(15, 23, 42, 0.85), rgba(88, 28, 135, 0.85)), 
                        url('https://source.unsplash.com/random/1920x1080/?dog,golden-retriever,nature');
            background-size: cover; 
            background-position: center;
            background-attachment: fixed;
            margin: 0; 
            display: flex; 
            height: 100vh; 
            overflow: hidden; 
            color: var(--text-dark);
        }

        /* --- PRELOADER --- */
        #app-wrapper { display: flex; width: 100%; height: 100%; display: none; } /* Hidden by default */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a202c; z-index: 9999; display: flex; justify-content: center; align-items: center; color: white; flex-direction: column; }

        /* --- SIDEBAR --- */
        .sidebar { 
            width: 260px; 
            background: var(--sidebar-bg); 
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255,255,255,0.1); 
            display: flex; flex-direction: column; padding: 25px; z-index: 10; color: white;
            box-shadow: 5px 0 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        .brand { font-size: 20px; font-weight: 600; color: #fff; margin-bottom: 40px; display: flex; align-items: center; gap: 12px; }
        .nav-item { 
            padding: 14px 18px; border-radius: 12px; cursor: pointer; color: #a0aec0; margin-bottom: 8px; transition: all 0.3s ease; 
            display: flex; align-items: center; gap: 15px; font-weight: 500; font-size: 14px;
            white-space: nowrap;
        }
        .nav-item:hover { background: rgba(255,255,255,0.1); color: white; transform: translateX(5px); }
        .nav-item.active { background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%); color: white; box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4); }
        .spacer { flex: 1; }

        /* --- MAIN AREA --- */
        .main { flex: 1; padding: 30px; overflow-y: auto; position: relative; }
        .view-section { display: none; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .view-section.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        h2 { margin-top: 0; font-size: 26px; margin-bottom: 25px; color: white; font-weight: 600; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }

        /* --- GLASS PANEL & FORMS --- */
        .glass-panel { 
            background: var(--glass-bg); 
            border-radius: 20px; 
            border: var(--glass-border); 
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px); /* Fixes Safari */
            transform: translateZ(0); /* FIX: Forces rounded corners to clip properly */
        }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .form-group { margin-bottom: 15px; position: relative; }
        label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #4a5568; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* CAPS LOCK INPUTS */
        input, select, textarea { 
            width: 100%; padding: 12px 15px; border: 2px solid #e2e8f0; border-radius: 10px; 
            font-family: inherit; font-size: 14px; box-sizing: border-box; background: rgba(255,255,255,0.8); transition: all 0.2s;
            text-transform: uppercase;
        }
        input:focus, select:focus { outline: none; border-color: var(--primary); background: white; }
        input:disabled, select:disabled { background: #edf2f7; color: #a0aec0; cursor: not-allowed; }

        /* --- AUTOCOMPLETE SUGGESTIONS --- */
        .autocomplete-items {
            position: absolute; border: 1px solid #d4d4d4; border-bottom: none; border-top: none; z-index: 99;
            top: 100%; left: 0; right: 0; border-radius: 0 0 10px 10px; overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .autocomplete-items div {
            padding: 10px; cursor: pointer; background-color: #fff; border-bottom: 1px solid #d4d4d4;
            font-size: 13px; text-transform: uppercase;
        }
        .autocomplete-items div:hover { background-color: #e9e9e9; }

        /* --- CUSTOM FILE UPLOAD --- */
        .file-upload-box {
            position: relative; height: 120px; border: 2px dashed #cbd5e0; border-radius: 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.5); cursor: pointer; transition: 0.2s; text-align: center;
        }
        .file-upload-box:hover { border-color: var(--primary); background: rgba(255,255,255,0.8); }
        .file-upload-box input { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .file-info { font-size: 12px; color: var(--text-light); pointer-events: none; }
        .file-preview { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; display: none; position: absolute; top:0; left:0; pointer-events: none; }

        /* --- BUTTONS --- */
        .btn { padding: 12px 24px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 14px; display: inline-flex; align-items: center; gap: 8px; justify-content: center; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 4px 10px rgba(118, 75, 162, 0.3); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-secondary { background: #e2e8f0; color: var(--text-dark); }
        .btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .btn-sm { padding: 8px 16px; font-size: 12px; }

        /* --- TOGGLE SWITCH --- */
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(24px); }

        /* --- MAP --- */
        #map, #edit-map { height: 250px; border-radius: 15px; margin-top: 10px; border: 4px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 1; }

        /* --- TABLE & FILTERS --- */
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { background: rgba(237, 242, 247, 0.9); padding: 16px; font-weight: 600; color: #4a5568; text-align: left; font-size: 12px; border-bottom: 2px solid #e2e8f0; }
        td { padding: 16px; border-bottom: 1px solid #edf2f7; vertical-align: middle; background: rgba(255,255,255,0.6); cursor: pointer; text-transform: uppercase; white-space: nowrap; }
        tr:hover td { background: rgba(255,255,255,1); }
        .dog-thumb { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .filters-bar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .filters-bar select { width: auto; min-width: 150px; padding: 8px; font-size: 13px; }

        /* --- MODALS --- */
        #editor-modal, #password-modal { 
            position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index: 2000;
            display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        .editor-content { 
            background: #fff; width: 700px; max-width: 95%; max-height: 90vh; overflow-y: auto;
            border-radius: 20px; padding: 30px; position: relative; animation: popIn 0.3s;
        }
        .password-content {
            background: #fff; width: 400px; padding: 30px; border-radius: 20px; text-align: center; animation: popIn 0.3s;
        }
        .editor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .editor-actions { display: flex; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; justify-content: flex-end; }

        #modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index: 3000; display:none; justify-content:center; align-items:center; }
        .alert-box { background: white; padding: 30px; border-radius: 20px; width: 350px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }

        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        /* PRINT HIDING */
        #print-area { display: none; }
        
        /* PRINT LAYOUT */
        @media print { 
            body * { visibility: hidden; } 
            #print-area, #print-area * { visibility: visible; } 
            #print-area { display: block; position: absolute; left: 0; top: 0; width: 100%; background: white; z-index: 9999; }
            .print-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-family: Arial, sans-serif; font-size: 12px; }
            .print-table th, .print-table td { border: 1px solid #000; padding: 8px; text-align: left; text-transform: uppercase; }
            .print-header { text-align: center; margin-bottom: 30px; font-family: Arial, sans-serif; }
            .print-header h2, .print-header h3, .print-header p { margin: 2px; color: black; }
            .signatories { margin-top: 50px; display: flex; justify-content: space-between; page-break-inside: avoid; }
            .sign-box { text-align: center; width: 40%; border-top: 1px solid black; padding-top: 10px; }
        }

        /* --- MOBILE RESPONSIVE STYLES --- */
        @media screen and (max-width: 768px) {
            body { flex-direction: column; height: auto; overflow-y: auto; }
            
            /* Sidebar becomes Top Nav */
            .sidebar { 
                width: 100%; height: auto; flex-direction: row; overflow-x: auto; 
                padding: 15px; position: sticky; top: 0; order: 0;
                border-right: none; border-bottom: 1px solid rgba(255,255,255,0.1);
                justify-content: flex-start; gap: 15px;
            }
            .sidebar .brand { font-size: 16px; margin: 0 15px 0 0; white-space: nowrap; }
            .sidebar .nav-item { margin: 0; padding: 8px 12px; font-size: 12px; }
            .sidebar .spacer { display: none; }

            /* Main Content */
            .main { width: 100%; padding: 15px; height: auto; overflow: visible; }
            
            /* Stack Forms */
            .form-grid { grid-template-columns: 1fr; gap: 15px; }
            
            /* Scrollable Table */
            .glass-panel { overflow-x: auto; }
            
            /* Modals */
            .editor-content, .password-content { width: 90%; max-height: 85vh; padding: 20px; }
            #view-buttons { flex-direction: column; width: 100%; }
            #view-buttons button { width: 100%; margin: 5px 0 !important; }
            .filters-bar { flex-direction: column; }
            .filters-bar select, .filters-bar input, .filters-bar button { width: 100% !important; }
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <i class="fas fa-paw fa-spin" style="font-size: 50px; margin-bottom: 20px;"></i>
        <div>Verifying Credentials...</div>
    </div>

    <div id="app-wrapper">
        <div class="sidebar">
            <div class="brand"><i class="fas fa-shield-dog"></i> Barangay K9</div>
            <div class="nav-item active" id="nav-add" onclick="switchTab('add')"><i class="fas fa-plus-circle"></i> Registration</div>
            <div class="nav-item" id="nav-records" onclick="switchTab('records')"><i class="fas fa-folder-open"></i> Database</div>
            <div class="nav-item" id="nav-scan" onclick="switchTab('scan')"><i class="fas fa-qrcode"></i> Scan QR</div>
            
            <div class="spacer"></div> <div class="nav-item" id="nav-config" onclick="switchTab('config')"><i class="fas fa-sliders-h"></i> Configuration</div>
            <div class="nav-item" style="color: var(--danger);" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Sign Out</div>
        </div>

        <div class="main">
            <div id="tab-add" class="view-section active">
                <h2>New Registration</h2>
                <div class="glass-panel">
                    <div class="form-grid">
                        <div>
                            <div class="form-group">
                                <label>Dog's Name <span style="color:var(--danger)">*</span></label>
                                <input type="text" id="add-name" placeholder="e.g. BANTAY">
                            </div>
                            <div class="form-group">
                                <label>Breed</label>
                                <input list="breeds" id="add-breed" placeholder="SELECT OR TYPE CUSTOM BREED..." onchange="checkBreedInput(this)">
                                <datalist id="breeds">
                                    <option value="ASPIN (ASONG PINOY)">
                                    <option value="GOLDEN RETRIEVER">
                                    <option value="SHIH TZU">
                                    <option value="GERMAN SHEPHERD">
                                    <option value="LABRADOR">
                                    <option value="POODLE">
                                    <option value="BEAGLE">
                                    <option value="BULLDOG">
                                    <option value="SIBERIAN HUSKY">
                                </datalist>
                            </div>
                            <div class="form-grid" style="gap: 10px;">
                                <div class="form-group">
                                    <label>Eye Color</label>
                                    <select id="add-eye">
                                        <option value="BLACK">BLACK</option>
                                        <option value="BROWN">BROWN</option>
                                        <option value="BLUE">BLUE</option>
                                        <option value="HETEROCHROMIA">HETEROCHROMIA</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Body Color</label>
                                    <select id="add-color">
                                        <option value="BLACK">BLACK</option>
                                        <option value="WHITE">WHITE</option>
                                        <option value="BROWN">BROWN</option>
                                        <option value="CREAM">CREAM</option>
                                        <option value="SPOTTED">SPOTTED</option>
                                        <option value="TRICOLOR">TRICOLOR</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Photo Evidence <span style="color:var(--danger)">*</span></label>
                                <div class="file-upload-box" onclick="document.getElementById('add-photo').click()">
                                    <input type="file" id="add-photo" accept="image/*" onchange="previewImage(this, 'add-preview')">
                                    <i class="fas fa-cloud-upload-alt" style="font-size: 24px; color: var(--primary); margin-bottom: 5px;"></i>
                                    <span class="file-info">Click to Upload Image</span>
                                    <img id="add-preview" class="file-preview">
                                </div>
                            </div>
                        </div>

                        <div>
                            <div class="form-group" style="position:relative;">
                                <label>Owner's Name <span style="color:var(--danger)">*</span></label>
                                <input type="text" id="add-owner" placeholder="SEARCH OR ENTER FULL NAME" oninput="debounceOwnerSearch()">
                                <div id="owner-suggestions" class="autocomplete-items"></div>
                            </div>
                            <div class="form-group">
                                <label>Phone Number</label>
                                <input type="text" id="add-phone" placeholder="0912 345 6789">
                            </div>
                            <div class="form-group">
                                <label>Location Mapping <span style="color:#718096; font-size:11px;">(Optional)</span></label>
                                <button class="btn btn-sm btn-secondary" style="width:100%; margin-bottom: 5px;" onclick="locateUser()">
                                    <i class="fas fa-crosshairs"></i> Get My Current Location
                                </button>
                                <div id="map"></div>
                                <input type="hidden" id="add-lat">
                                <input type="hidden" id="add-lng">
                                <input type="text" id="add-addr-text" placeholder="HOUSE NO. / STREET NAME" style="margin-top:10px;">
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="btn-save-dog" onclick="saveDogRecord()" style="width: 100%; margin-top: 25px; font-size: 16px;">
                        <i class="fas fa-save"></i> Save Record & Generate ID
                    </button>
                </div>
            </div>

            <div id="tab-records" class="view-section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                    <h2>Registry Database</h2>
                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                        <input type="text" id="search-box" placeholder="SEARCH..." onkeyup="debounceSearch()" style="width: 200px;">
                        <button class="btn btn-primary" onclick="printListReport()"><i class="fas fa-print"></i> Print List</button>
                    </div>
                </div>
                
                <div class="filters-bar">
                    <select id="filter-breed" onchange="loadRecords()">
                        <option value="">ALL BREEDS</option>
                        <option value="ASPIN (ASONG PINOY)">ASPIN</option>
                        <option value="GOLDEN RETRIEVER">GOLDEN RETRIEVER</option>
                        <option value="SHIH TZU">SHIH TZU</option>
                        <option value="GERMAN SHEPHERD">GERMAN SHEPHERD</option>
                        <option value="LABRADOR">LABRADOR</option>
                    </select>
                    <select id="filter-eye" onchange="loadRecords()">
                        <option value="">ALL EYE COLORS</option>
                        <option value="BLACK">BLACK</option>
                        <option value="BROWN">BROWN</option>
                        <option value="BLUE">BLUE</option>
                    </select>
                    <select id="filter-color" onchange="loadRecords()">
                        <option value="">ALL BODY COLORS</option>
                        <option value="BLACK">BLACK</option>
                        <option value="WHITE">WHITE</option>
                        <option value="BROWN">BROWN</option>
                        <option value="CREAM">CREAM</option>
                    </select>
                </div>

                <div class="glass-panel" style="padding: 0; overflow: hidden;">
                    <table id="records-table">
                        <thead><tr><th width="60">Img</th><th>Dog Name</th><th>Breed</th><th>Owner</th><th>Address</th></tr></thead>
                        <tbody id="tbody-records"></tbody>
                    </table>
                    <div style="padding: 15px; display: flex; justify-content: center; gap: 20px; border-top: 1px solid #eee; background: rgba(255,255,255,0.8);">
                        <button class="btn btn-sm btn-secondary" id="btn-prev" onclick="changePage(-1)" disabled>Prev</button>
                        <span id="page-indicator" style="font-weight:600; font-size:14px; padding-top: 4px;">Page 1</span>
                        <button class="btn btn-sm btn-primary" id="btn-next" onclick="changePage(1)">Next</button>
                    </div>
                </div>
            </div>

            <div id="tab-scan" class="view-section">
                <div class="glass-panel" style="max-width: 600px; margin: 0 auto; text-align: center;">
                    <h2><i class="fas fa-qrcode"></i> ID Scanner</h2>
                    <p style="color:#666; margin-bottom: 20px;">Verify an ID by scanning the QR Code.</p>
                    <div id="qr-container" style="background: #000; height: 300px; border-radius: 15px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
                        <div id="qr-placeholder" style="color: white;">Camera is Off</div>
                        <div id="qr-reader" style="width: 100%; height: 100%; display: none;"></div>
                    </div>
                    <button class="btn btn-success" onclick="startScanner()"><i class="fas fa-camera"></i> Open Camera</button>
                </div>
            </div>

            <div id="tab-config" class="view-section">
                <h2>System Configuration</h2>
                <div class="glass-panel">
                    <div class="form-grid">
                        <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                            <label style="margin:0;">Independent City (No Province)</label>
                            <label class="switch">
                                <input type="checkbox" id="cfg-independent" onchange="toggleIndependentCity()">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Region</label>
                            <select id="cfg-region" onchange="updateProvinces()"></select>
                        </div>
                        <div class="form-group" id="div-province">
                            <label>Province</label>
                            <select id="cfg-province"></select>
                        </div>
                        <div class="form-group">
                            <label id="label-muni">Municipality / City</label>
                            <input type="text" id="cfg-muni" placeholder="ENTER CITY/MUNICIPALITY NAME">
                        </div>
                        <div class="form-group">
                            <label>Barangay</label>
                            <input type="text" id="cfg-brgy" placeholder="ENTER BARANGAY NAME">
                        </div>
                    </div>
                    <h4 style="margin: 20px 0 10px 0; color: var(--primary);">Official Signatories</h4>
                    <div class="form-grid">
                        <div class="form-group"><label>Punong Barangay</label><input type="text" id="cfg-captain" placeholder="FULL NAME"></div>
                        <div class="form-group"><label>Barangay Secretary</label><input type="text" id="cfg-sec" placeholder="FULL NAME"></div>
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="saveConfig()"><i class="fas fa-save"></i> Save Settings</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="editor-modal">
        <div class="editor-content">
            <div class="editor-header">
                <h3 style="margin:0;">Animal Record Details</h3>
                <button onclick="closeEditor()" style="background:none; border:none; font-size:20px; cursor:pointer;">&times;</button>
            </div>
            
            <div class="form-grid">
                <div>
                    <input type="hidden" id="edit-id">
                    <div class="form-group">
                        <label>Dog Name</label>
                        <input type="text" id="edit-name" disabled>
                    </div>
                    <div class="form-group">
                        <label>Breed</label>
                        <input type="text" id="edit-breed" disabled>
                    </div>
                    <div class="form-group">
                        <label>Color</label>
                        <input type="text" id="edit-color" disabled>
                    </div>
                    <div class="form-group">
                        <label>Photo</label>
                        <div class="file-upload-box" id="edit-photo-box" style="display:none; height: 80px; margin-bottom: 10px;">
                            <input type="file" id="edit-photo-new" accept="image/*">
                            <span>Upload New Photo</span>
                        </div>
                        <img id="edit-photo-display" style="width:100%; height:150px; object-fit:cover; border-radius:10px;">
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <label>Owner Name</label>
                        <input type="text" id="edit-owner" disabled>
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <input type="text" id="edit-addr" disabled>
                    </div>
                    <div id="edit-map"></div>
                </div>
            </div>

            <div class="editor-actions">
                <div id="view-buttons" style="display: flex; gap: 10px; width: 100%; justify-content: flex-end;">
                    <button class="btn btn-danger" style="margin-right: auto;" onclick="showDeleteModal()"><i class="fas fa-trash"></i> Delete</button>
                    
                    <button class="btn btn-secondary" onclick="generatePrintableID(document.getElementById('edit-id').value, getCurrentEditData())"><i class="fas fa-print"></i> Print ID</button>
                    <button class="btn btn-primary" onclick="toggleEditMode(true)"><i class="fas fa-edit"></i> Edit Record</button>
                </div>
                <div id="edit-buttons" style="display:none;">
                    <button class="btn btn-danger" onclick="toggleEditMode(false)">Cancel</button>
                    <button class="btn btn-success" onclick="saveEdit()"><i class="fas fa-check"></i> Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <div id="password-modal">
        <div class="password-content">
            <h3 style="color: var(--danger);"><i class="fas fa-lock"></i> Admin Access</h3>
            <p>Please enter the admin password to delete this record.</p>
            <input type="password" id="admin-pw-input" placeholder="ENTER PASSWORD" style="text-align: center; font-size: 18px; margin-bottom: 20px;">
            <div style="display:flex; justify-content:center; gap:10px;">
                <button class="btn btn-secondary" onclick="document.getElementById('password-modal').style.display='none'">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Confirm Delete</button>
            </div>
        </div>
    </div>

    <div id="modal-overlay">
        <div class="alert-box">
            <div id="m-icon" style="font-size: 50px; margin-bottom: 15px;"></div>
            <h3 id="m-title" style="margin: 0;"></h3>
            <p id="m-msg" style="color: #666; margin: 15px 0;"></p>
            <button class="btn btn-primary" onclick="document.getElementById('modal-overlay').style.display='none'">Okay</button>
        </div>
    </div>

    <div id="print-area"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, getDocs, query, where, limit, startAfter, orderBy, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA19XQgYJDWHvBsiYWWbO4HX612VQDCbM8",
            authDomain: "barangay-animal-registry.firebaseapp.com",
            projectId: "barangay-animal-registry",
            messagingSenderId: "377200658839",
            appId: "1:377200658839:web:fc4074c2359970aa039cd2",
            measurementId: "G-JWY1GMSNQF"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const SUPABASE_URL = "https://bhracszppdphzwygeuld.supabase.co"; 
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJocmFjc3pwcGRwaHp3eWdldWxkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwMzE2MzEsImV4cCI6MjA4NTYwNzYzMX0.WtuLXrPlbzRU6oSrXnbHKxC6Bu-eUU91ahp-LJKCqjs";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const DELETE_PASSWORD = "admin123";

        // GLOBALS
        let map, editMap, marker, editMarker;
        let lastVisible = null;
        let currentPage = 1;
        let currentConfig = {};
        let searchTimer;
        let ownerSearchTimer;
        let html5QrCode;

        onAuthStateChanged(auth, user => {
            if(!user) {
                // Not logged in? Go back to login
                window.location.href = "index.html";
            } else {
                // Logged in? Hide loader, show app
                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('app-wrapper').style.display = 'flex';
                
                // Initialize regions first, then load user config
                initRegions().then(() => loadConfig());
            }
        });

        window.logout = () => signOut(auth).then(() => window.location.href = "index.html");

        // --- DYNAMIC LOCATION LOGIC (PSGC API) ---
        async function initRegions() {
            const regSel = document.getElementById('cfg-region');
            regSel.innerHTML = "<option>Loading Regions...</option>";
            try {
                const response = await fetch('https://psgc.gitlab.io/api/regions/');
                const data = await response.json();
                data.sort((a, b) => a.name.localeCompare(b.name));
                regSel.innerHTML = "";
                data.forEach(r => {
                    let opt = document.createElement('option');
                    opt.value = r.code; 
                    opt.innerText = r.name + " (" + r.regionName + ")";
                    regSel.appendChild(opt);
                });
                await updateProvinces();
            } catch (e) {
                console.error("Failed to load regions:", e);
                regSel.innerHTML = "<option>Error loading regions</option>";
            }
        }

        window.updateProvinces = async () => {
            const regCode = document.getElementById('cfg-region').value;
            const provSel = document.getElementById('cfg-province');
            provSel.innerHTML = "<option>Loading Provinces...</option>";
            provSel.disabled = true;

            try {
                const response = await fetch(`https://psgc.gitlab.io/api/regions/${regCode}/provinces/`);
                const data = await response.json();
                data.sort((a, b) => a.name.localeCompare(b.name));
                provSel.innerHTML = "";
                data.forEach(p => {
                    let opt = document.createElement('option');
                    opt.value = p.name;
                    opt.innerText = p.name;
                    provSel.appendChild(opt);
                });
                provSel.disabled = false;
            } catch (e) {
                console.error("Failed to load provinces:", e);
                provSel.innerHTML = "<option>No provinces found</option>";
                provSel.disabled = false;
            }
        };

        // --- UI UTILS ---
        window.switchTab = (tabId) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            document.getElementById(`nav-${tabId}`).classList.add('active');
            
            if(tabId === 'add') setTimeout(() => { if(!map) initMap(); else map.invalidateSize(); }, 200);
            if(tabId === 'records') loadRecords();
        };

        window.previewImage = (input, imgId) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.getElementById(imgId);
                    img.src = e.target.result;
                    img.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        window.showAlert = (t, m, type='info') => {
            document.getElementById('m-title').innerText = t;
            document.getElementById('m-msg').innerText = m;
            const icon = document.getElementById('m-icon');
            if(type=='error') { icon.innerHTML='âš ï¸'; icon.style.color='var(--danger)'; }
            else if(type=='success') { icon.innerHTML='ðŸŽ‰'; icon.style.color='var(--success)'; }
            else { icon.innerHTML='â„¹ï¸'; icon.style.color='var(--primary)'; }
            document.getElementById('modal-overlay').style.display = 'flex';
        };

        // --- OWNER SEARCH (300ms Debounce) ---
        window.debounceOwnerSearch = () => {
            clearTimeout(ownerSearchTimer);
            ownerSearchTimer = setTimeout(performOwnerSearch, 300);
        };

        async function performOwnerSearch() {
            const term = document.getElementById('add-owner').value.toUpperCase().trim();
            const suggestionsDiv = document.getElementById('owner-suggestions');
            suggestionsDiv.innerHTML = "";
            
            if(term.length < 2) return;

            const q = query(collection(db, "dogs"), 
                where("owner", ">=", term), 
                where("owner", "<=", term + '\uf8ff'),
                limit(5));
                
            const snap = await getDocs(q);
            const uniqueOwners = new Set();

            snap.forEach(doc => { uniqueOwners.add(doc.data().owner); });

            uniqueOwners.forEach(ownerName => {
                const div = document.createElement('div');
                div.innerText = ownerName;
                div.onclick = () => {
                    document.getElementById('add-owner').value = ownerName;
                    suggestionsDiv.innerHTML = "";
                };
                suggestionsDiv.appendChild(div);
            });
        }

        // --- MAPS ---
        function initMap() {
            map = L.map('map').setView([18.25, 122.1], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            map.on('click', function(e) { placePin(e.latlng.lat, e.latlng.lng, 'add'); });
        }
        function initEditMap(lat, lng) {
            if(editMap) { editMap.remove(); }
            const hasLocation = lat && lng;
            const center = hasLocation ? [lat, lng] : [18.25, 122.1]; 
            const zoom = hasLocation ? 15 : 13;
            editMap = L.map('edit-map').setView(center, zoom);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(editMap);
            if (hasLocation) { editMarker = L.marker([lat, lng]).addTo(editMap); } 
            else { editMarker = null; }
            editMap.on('click', (e) => {
                if(!document.getElementById('edit-name').disabled) {
                    if(editMarker) { editMarker.setLatLng(e.latlng); } 
                    else { editMarker = L.marker(e.latlng).addTo(editMap); }
                }
            });
        }
        function placePin(lat, lng, mode) {
            if(mode === 'add') {
                if(marker) map.removeLayer(marker);
                marker = L.marker([lat, lng]).addTo(map);
                document.getElementById('add-lat').value = lat;
                document.getElementById('add-lng').value = lng;
            }
        }
        window.locateUser = () => {
            navigator.geolocation.getCurrentPosition(pos => {
                map.setView([pos.coords.latitude, pos.coords.longitude], 16);
                placePin(pos.coords.latitude, pos.coords.longitude, 'add');
            });
        };

        window.compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width; let height = img.height;
                        const MAX_WIDTH = 1024; const MAX_HEIGHT = 1024;
                        if (width > height) { if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } } 
                        else { if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; } }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => { resolve(blob); }, 'image/jpeg', 0.7);
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        };

        // --- SAVE DOG ---
        window.saveDogRecord = async () => {
            const name = document.getElementById('add-name').value.toUpperCase();
            const owner = document.getElementById('add-owner').value.toUpperCase();
            const file = document.getElementById('add-photo').files[0];
            const breed = document.getElementById('add-breed').value.toUpperCase();
            const color = document.getElementById('add-color').value.toUpperCase();
            const eye = document.getElementById('add-eye').value.toUpperCase();
            const addrText = document.getElementById('add-addr-text').value.toUpperCase();

            if(!name || !owner || !file) return showAlert("Missing Info", "Name, Owner, and Photo are required.", "error");

            const btn = document.getElementById('btn-save-dog');
            btn.disabled = true; btn.innerText = "Compressing & Uploading...";

            try {
                const compressedBlob = await window.compressImage(file);
                const fileName = Date.now() + '-' + file.name.replace(/\s/g, '').replace(/\.[^/.]+$/, "") + ".jpg";
                const { data, error } = await supabase.storage.from('dogs').upload(fileName, compressedBlob);
                if (error) throw new Error("Supabase Upload Error: " + error.message);

                const { data: urlData } = supabase.storage.from('dogs').getPublicUrl(fileName);
                const photoURL = urlData.publicUrl;

                await addDoc(collection(db, "dogs"), {
                    name, owner, breed, color, eye, photoURL,
                    lat: document.getElementById('add-lat').value || null, 
                    lng: document.getElementById('add-lng').value || null,
                    address: addrText,
                    createdAt: new Date(),
                    searchKeywords: [name.toLowerCase(), owner.toLowerCase()]
                });

                document.getElementById('add-name').value = '';
                document.getElementById('add-owner').value = '';
                document.getElementById('add-phone').value = '';
                document.getElementById('add-addr-text').value = '';
                document.getElementById('add-photo').value = '';
                document.getElementById('add-preview').style.display = 'none';
                if(marker) map.removeLayer(marker);
                
                btn.innerHTML = '<i class="fas fa-check"></i> Saved!';
                setTimeout(() => { btn.disabled=false; btn.innerText="Save Record & Generate ID"; }, 2000);
            } catch (e) {
                console.error(e);
                showAlert("Error", e.message, "error");
                btn.disabled = false; btn.innerText = "Save Record & Generate ID";
            }
        };

        // --- RECORDS LOAD ---
        async function loadRecords(direction = 0) {
            const tbody = document.getElementById('tbody-records');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Loading...</td></tr>';
            let qRef = collection(db, "dogs");
            let constraints = [orderBy("createdAt", "desc")];
            const fBreed = document.getElementById('filter-breed').value;
            const fEye = document.getElementById('filter-eye').value;
            const fColor = document.getElementById('filter-color').value;
            if(fBreed) constraints.push(where("breed", "==", fBreed));
            if(fEye) constraints.push(where("eye", "==", fEye));
            if(fColor) constraints.push(where("color", "==", fColor));
            if(direction === 1 && lastVisible) constraints.push(startAfter(lastVisible));
            if(direction === -1) { currentPage = 1; } else if (direction === 1) currentPage++;
            constraints.push(limit(5));
            const q = query(qRef, ...constraints);
            try {
                const snap = await getDocs(q);
                tbody.innerHTML = "";
                if (snap.empty) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No records found.</td></tr>'; return; }
                lastVisible = snap.docs[snap.docs.length - 1];
                document.getElementById('page-indicator').innerText = `Page ${currentPage}`;
                document.getElementById('btn-prev').disabled = (currentPage === 1);
                snap.forEach(doc => {
                    const d = doc.data();
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td><img src="${d.photoURL}" class="dog-thumb"></td><td><b>${d.name}</b></td><td>${d.breed}</td><td>${d.owner}</td><td>${d.address || 'Pinned'}</td>`;
                    tr.onclick = () => openEditor(doc.id, d);
                    tbody.appendChild(tr);
                });
            } catch(e) {
                console.error("Query Error", e);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:red;">Index required. Check Console.</td></tr>';
            }
        }
        window.changePage = (dir) => loadRecords(dir);

        // --- PRINT LIST REPORT ---
        window.printListReport = async () => {
            const fBreed = document.getElementById('filter-breed').value;
            const fEye = document.getElementById('filter-eye').value;
            const fColor = document.getElementById('filter-color').value;
            let qRef = collection(db, "dogs");
            let constraints = [orderBy("name", "asc")]; 
            if(fBreed) constraints.push(where("breed", "==", fBreed));
            if(fEye) constraints.push(where("eye", "==", fEye));
            if(fColor) constraints.push(where("color", "==", fColor));
            const q = query(qRef, ...constraints);
            const snap = await getDocs(q);
            let rows = "";
            snap.forEach(doc => {
                const d = doc.data();
                rows += `<tr><td>${d.name}</td><td>${d.breed}</td><td>${d.color}</td><td>${d.eye}</td><td>${d.owner}</td><td>${d.address || ''}</td></tr>`;
            });
            const c = currentConfig;
            let headerText = "Republic of the Philippines<br>";
            if(c.region === "BARMM") headerText += "Autonomous Region in Muslim Mindanao<br>";
            if(!document.getElementById('cfg-independent').checked) headerText += `Province of ${c.province || "..."}<br>`;
            headerText += `${document.getElementById('cfg-independent').checked ? "City" : "Municipality"} of ${c.muni || "..."}<br><b>BARANGAY ${c.brgy ? c.brgy.toUpperCase() : "..."}</b>`;

            document.getElementById('print-area').innerHTML = `
                <div class="print-header">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/84/Coat_of_arms_of_the_Philippines.svg/1200px-Coat_of_arms_of_the_Philippines.svg.png" style="width:60px; margin-bottom:10px;">
                    <p>${headerText}</p>
                    <h3>OFFICIAL DOG REGISTRY MASTER LIST</h3>
                    <p>Total Records: ${snap.size}</p>
                </div>
                <table class="print-table"><thead><tr><th>Name</th><th>Breed</th><th>Color</th><th>Eyes</th><th>Owner</th><th>Address</th></tr></thead><tbody>${rows}</tbody></table>
                <div class="signatories">
                    <div class="sign-box"><b>${c.sec ? c.sec.toUpperCase() : "..."}</b><br>Barangay Secretary</div>
                    <div class="sign-box"><b>${c.captain ? c.captain.toUpperCase() : "..."}</b><br>Punong Barangay</div>
                </div>`;
            window.print();
        };

        // --- VIEWER / EDITOR ---
        let currentRecord = null;
        window.openEditor = (id, data) => {
            currentRecord = { id, ...data };
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-name').value = data.name;
            document.getElementById('edit-breed').value = data.breed;
            document.getElementById('edit-color').value = data.color;
            document.getElementById('edit-owner').value = data.owner;
            document.getElementById('edit-addr').value = data.address;
            document.getElementById('edit-photo-display').src = data.photoURL;
            toggleEditMode(false); 
            document.getElementById('editor-modal').style.display = 'flex';
            setTimeout(() => initEditMap(data.lat, data.lng), 300);
        };
        window.closeEditor = () => document.getElementById('editor-modal').style.display = 'none';
        window.toggleEditMode = (isEdit) => {
            const inputs = ['edit-name', 'edit-breed', 'edit-color', 'edit-owner', 'edit-addr'];
            inputs.forEach(id => document.getElementById(id).disabled = !isEdit);
            document.getElementById('view-buttons').style.display = isEdit ? 'none' : 'flex';
            document.getElementById('edit-buttons').style.display = isEdit ? 'block' : 'none';
            document.getElementById('edit-photo-box').style.display = isEdit ? 'flex' : 'none';
        };
        window.saveEdit = async () => {
            const id = document.getElementById('edit-id').value;
            const file = document.getElementById('edit-photo-new').files[0];
            const updates = {
                name: document.getElementById('edit-name').value.toUpperCase(),
                breed: document.getElementById('edit-breed').value.toUpperCase(),
                color: document.getElementById('edit-color').value.toUpperCase(),
                owner: document.getElementById('edit-owner').value.toUpperCase(),
                address: document.getElementById('edit-addr').value.toUpperCase(),
            };
            if (editMarker) { updates.lat = editMarker.getLatLng().lat; updates.lng = editMarker.getLatLng().lng; }
            try {
                if(file) {
                    const compressedBlob = await window.compressImage(file);
                    const fileName = Date.now() + '-edited-' + file.name.replace(/\s/g, '').replace(/\.[^/.]+$/, "") + ".jpg";
                    const { data, error } = await supabase.storage.from('dogs').upload(fileName, compressedBlob);
                    if (error) throw new Error("Supabase Upload Error: " + error.message);
                    const { data: urlData } = supabase.storage.from('dogs').getPublicUrl(fileName);
                    updates.photoURL = urlData.publicUrl;
                }
                await updateDoc(doc(db, "dogs", id), updates);
                showAlert("Success", "Record updated!", "success");
                closeEditor();
                loadRecords();
            } catch(e) { console.error(e); showAlert("Error", e.message, "error"); }
        };
        window.showDeleteModal = () => { document.getElementById('admin-pw-input').value = ""; document.getElementById('password-modal').style.display = 'flex'; };
        window.confirmDelete = async () => {
            const pw = document.getElementById('admin-pw-input').value;
            if (pw !== DELETE_PASSWORD) { alert("INCORRECT PASSWORD"); return; }
            document.getElementById('password-modal').style.display = 'none';
            const id = document.getElementById('edit-id').value;
            const photoURL = document.getElementById('edit-photo-display').src;
            try {
                const urlObj = new URL(photoURL);
                const pathParts = urlObj.pathname.split('/'); 
                const fileName = decodeURIComponent(pathParts[pathParts.length - 1]);
                if(fileName) { const { error } = await supabase.storage.from('dogs').remove([fileName]); }
                await deleteDoc(doc(db, "dogs", id));
                showAlert("Deleted", "Record removed permanently.", "success");
                closeEditor();
                loadRecords();
            } catch(e) { console.error(e); showAlert("Error", "Failed to delete: " + e.message, "error"); }
        };
        window.getCurrentEditData = () => {
             return {
                 name: document.getElementById('edit-name').value,
                 breed: document.getElementById('edit-breed').value,
                 color: document.getElementById('edit-color').value,
                 eye: "",
                 owner: document.getElementById('edit-owner').value,
                 address: document.getElementById('edit-addr').value,
                 photoURL: document.getElementById('edit-photo-display').src
             };
        }
        
        // --- IMPROVED SCANNER (Handles URLs and raw IDs) ---
        window.startScanner = () => {
            document.getElementById('qr-placeholder').style.display = 'none';
            document.getElementById('qr-reader').style.display = 'block';
            html5QrCode = new Html5Qrcode("qr-reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } },
                (decodedText) => {
                    html5QrCode.stop();
                    let id = decodedText;
                    // Attempt to extract ID if it's a URL (like your dashboard generates)
                    try {
                        const url = new URL(decodedText);
                        const idParam = url.searchParams.get("id");
                        if(idParam) id = idParam;
                    } catch(e) {
                        // If it fails, it's just a raw ID (like the demo generates) - do nothing, use `id` as is.
                    }
                    
                    if(id) { 
                        getDoc(doc(db, "dogs", id)).then(snap => { 
                            if(snap.exists()) openEditor(snap.id, snap.data()); 
                            else showAlert("Error", "ID not found.", "error"); 
                        }); 
                    }
                }, () => {}
            );
        };
        
        window.debounceSearch = () => { clearTimeout(searchTimer); searchTimer = setTimeout(runSearch, 300); };
        async function runSearch() {
            const term = document.getElementById('search-box').value.toUpperCase();
            if(!term) { loadRecords(-1); return; }
            const q = query(collection(db, "dogs")); 
            const snap = await getDocs(q);
            const tbody = document.getElementById('tbody-records');
            tbody.innerHTML = "";
            let count = 0;
            snap.forEach(doc => {
                if(count > 4) return;
                const d = doc.data();
                if(d.name.includes(term) || d.owner.includes(term)) {
                    count++;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td><img src="${d.photoURL}" class="dog-thumb"></td><td><b>${d.name}</b></td><td>${d.breed}</td><td>${d.owner}</td><td>${d.address}</td>`;
                    tr.onclick = () => openEditor(doc.id, d);
                    tbody.appendChild(tr);
                }
            });
        }
        
        // --- IMPROVED PRINT ID (Larger QR Code) ---
        window.generatePrintableID = (id, data) => {
            const c = currentConfig;
            const isIndep = document.getElementById('cfg-independent').checked;
            let headerText = "Republic of the Philippines<br>";
            if(c.region === "BARMM") headerText += "Autonomous Region in Muslim Mindanao<br>";
            if(!isIndep) headerText += `Province of ${c.province || "..."}<br>`;
            headerText += `${isIndep ? "City" : "Municipality"} of ${c.muni || "..."}<br><b>BARANGAY ${c.brgy ? c.brgy.toUpperCase() : "..."}</b>`;
            document.getElementById('print-area').innerHTML = `
                <div style="width: 3.375in; height: 2.125in; border: 2px solid black; padding: 10px; font-family: Arial; position: relative; page-break-inside: avoid; margin: 10px;">
                    <div style="text-align: center; font-size: 8px; line-height: 1.2; margin-bottom: 5px;">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/84/Coat_of_arms_of_the_Philippines.svg/1200px-Coat_of_arms_of_the_Philippines.svg.png" style="position:absolute; left:5px; top:5px; width:30px;">
                        ${headerText}
                        <h3 style="margin: 2px 0; font-size: 12px; text-decoration: underline;">OFFICIAL ANIMAL REGISTRY ID</h3>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <img src="${data.photoURL}" style="width: 70px; height: 70px; border: 1px solid #000; object-fit: cover;">
                        <div style="font-size: 9px;">
                            <div style="font-size: 14px; font-weight: bold;">${data.name.toUpperCase()}</div>
                            <div>Breed: ${data.breed}</div>
                            <div>Color: ${data.color}</div>
                            <div>Owner: <b>${data.owner}</b></div>
                            <div>Addr: ${data.address}</div>
                        </div>
                        <div id="print-qr-${id}"></div>
                    </div>
                    <div style="margin-top: 15px; display: flex; justify-content: space-between; font-size: 7px; text-align: center;">
                        <div style="width: 30%; border-top: 1px solid black;"><b>${data.owner.toUpperCase()}</b><br>Owner's Signature</div>
                        <div style="width: 30%; border-top: 1px solid black;"><b>${c.sec ? c.sec.toUpperCase() : "..."}</b><br>Barangay Secretary</div>
                        <div style="width: 30%; border-top: 1px solid black;"><b>${c.captain ? c.captain.toUpperCase() : "..."}</b><br>Punong Barangay</div>
                    </div>
                </div>`;
            
            // INCREASED SIZE FROM 50 to 128 (Makes it readable)
            new QRCode(document.getElementById(`print-qr-${id}`), { text: `https://barangay-animal-registry.web.app/index.html?id=${id}`, width: 128, height: 128 });
            setTimeout(() => window.print(), 500);
        };
        
        window.toggleIndependentCity = () => {
            const isIndep = document.getElementById('cfg-independent').checked;
            document.getElementById('div-province').style.display = isIndep ? 'none' : 'block';
            document.getElementById('label-muni').innerText = isIndep ? "City" : "Municipality / City";
        };
        window.saveConfig = async () => {
            const cfg = {
                region: document.getElementById('cfg-region').value,
                province: document.getElementById('cfg-province').value,
                muni: document.getElementById('cfg-muni').value,
                brgy: document.getElementById('cfg-brgy').value,
                captain: document.getElementById('cfg-captain').value,
                sec: document.getElementById('cfg-sec').value,
                independentCity: document.getElementById('cfg-independent').checked
            };
            await setDoc(doc(db, "settings", "general"), cfg);
            currentConfig = cfg;
            showAlert("Settings Saved", "Configuration updated.", "success");
        };
        async function loadConfig() {
            const snap = await getDoc(doc(db, "settings", "general"));
            if(snap.exists()) {
                currentConfig = snap.data();
                if (currentConfig.region) {
                    document.getElementById('cfg-region').value = currentConfig.region;
                    await updateProvinces();
                }
                document.getElementById('cfg-province').value = currentConfig.province || "";
                document.getElementById('cfg-muni').value = currentConfig.muni;
                document.getElementById('cfg-brgy').value = currentConfig.brgy;
                document.getElementById('cfg-captain').value = currentConfig.captain;
                document.getElementById('cfg-sec').value = currentConfig.sec;
                document.getElementById('cfg-independent').checked = currentConfig.independentCity || false;
                toggleIndependentCity();
            }
        }
    </script>
</body>
</html>
